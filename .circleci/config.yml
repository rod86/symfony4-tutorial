version: 2
jobs:
    build:
        working_directory: ~/micropost
        docker:
            - image: circleci/php:7.2.4-apache-stretch-node-browsers
              environment:
                APP_ENV: test
                DATABASE_URL: mysql://root:root@127.0.0.1/micro-post
                MAILER_FROM: micropost@example.com
                MAILER_URL: null://localhost
            - image: circleci/mysql:5.7
              environment:
                MYSQL_ROOT_PASSWORD: 'root'
                MYSQL_DATABASE: micro-post

        steps:
            - checkout
            - run:
                name: Install packages
                command: sudo apt-get update && sudo apt-get install -y libzip-dev zip
            - run:
                name: Install PHP Extensions
                command: sudo docker-php-ext-install pdo_mysql zip
            - run:
                name: Wait for MySQL
                command: dockerize -wait tcp://127.0.0.1:3306 -timeout 120s
            - run:
                name: Composer
                command: sudo composer self-update
            - run:
                name: Composer install
                command: composer install -n --prefer-dist
            - run:
                name: Run migrations
                command: php bin/console doctrine:migrations:migrate --env=test --no-interaction
            